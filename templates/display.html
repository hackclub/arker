<!DOCTYPE html>
<html>
<head>
    <title>Archive - {{.short_id}}</title>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        .archive-bar { 
            background: #f8f9fa; 
            padding: 10px 20px; 
            border-bottom: 1px solid #ddd; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .archive-info { font-weight: bold; }
        .archive-date { color: #666; font-size: 14px; }
        .tabs { 
            display: flex; 
            background: #e9ecef; 
            margin: 0; 
            padding: 0; 
            list-style: none; 
            border-bottom: 1px solid #ddd;
        }
        .tabs li { margin: 0; }
        .tabs a { 
            display: block; 
            padding: 12px 20px; 
            text-decoration: none; 
            color: #495057; 
            border-right: 1px solid #ddd;
            text-transform: capitalize;
        }
        .tabs a:hover, .tabs a.active { 
            background: white; 
            color: #007bff; 
        }
        .tab-content { 
            padding: 20px; 
            min-height: 500px;
        }
        .tab-content.mhtml-active {
            padding: 0;
        }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .tab-pane#tab-mhtml { 
            position: relative; 
            padding: 0; 
            margin: 0;
            height: calc(100vh - 120px); /* Full height minus header and tabs */
        }
        .download-link { 
            display: inline-block; 
            padding: 10px 20px; 
            background: #007bff; 
            color: white; 
            text-decoration: none; 
            border-radius: 4px; 
            margin-bottom: 20px;
        }
        .download-link:hover { background: #0056b3; }
        .mhtml-download-link {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .git-clone { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 4px; 
            font-family: monospace; 
            margin-bottom: 20px;
        }
        .screenshot-img { max-width: 100%; height: auto; border: 1px solid #ddd; }
        .video-player { max-width: 100%; height: auto; }
        .mhtml-iframe { 
            width: 100%; 
            height: 100%; 
            border: none;
        }
        .status-pending { color: #ffc107; font-style: italic; }
        .status-failed { color: #dc3545; font-style: italic; }
        .status-processing { color: #17a2b8; font-style: italic; }
        .log-container { 
            background: #f8f9fa; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            padding: 15px; 
            margin: 15px 0;
            max-height: 400px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px; 
            white-space: pre-wrap;
        }
        .processing-header { 
            background: #e3f2fd; 
            padding: 10px; 
            border-radius: 4px; 
            margin-bottom: 10px; 
            border-left: 4px solid #2196f3; 
        }
    </style>
</head>
<body>
    <div class="archive-bar">
        <div class="archive-info">{{.domain}}</div>
        <div class="archive-date">Archived: {{.date}}</div>
    </div>

    <ul class="tabs">
        {{if .is_git}}
            {{/* Show git tab first for git repositories */}}
            {{range .archives}}
            {{if eq .Type "git"}}
            <li><a href="#tab-{{.Type}}" onclick="showTab('{{.Type}}')" class="{{if or (eq .Status "pending") (eq .Status "processing")}}status-processing{{end}} git-tab-first">
                {{.Type}}
                {{if eq .Status "processing"}} ⟳{{end}}
                {{if eq .Status "pending"}} ⏳{{end}}
                {{if eq .Status "failed"}} ✗{{end}}
            </a></li>
            {{end}}
            {{end}}
            {{/* Then show other tabs */}}
            {{range .archives}}
            {{if ne .Type "git"}}
            <li><a href="#tab-{{.Type}}" onclick="showTab('{{.Type}}')" class="{{if or (eq .Status "pending") (eq .Status "processing")}}status-processing{{end}}">
                {{.Type}}
                {{if eq .Status "processing"}} ⟳{{end}}
                {{if eq .Status "pending"}} ⏳{{end}}
                {{if eq .Status "failed"}} ✗{{end}}
            </a></li>
            {{end}}
            {{end}}
        {{else}}
            {{/* Default order for non-git URLs */}}
            {{range .archives}}
            <li><a href="#tab-{{.Type}}" onclick="showTab('{{.Type}}')" class="{{if or (eq .Status "pending") (eq .Status "processing")}}status-processing{{end}}">
                {{.Type}}
                {{if eq .Status "processing"}} ⟳{{end}}
                {{if eq .Status "pending"}} ⏳{{end}}
                {{if eq .Status "failed"}} ✗{{end}}
            </a></li>
            {{end}}
        {{end}}
    </ul>

    <div class="tab-content">
        {{range .archives}}
        <div id="tab-{{.Type}}" class="tab-pane">
            {{if eq .Status "completed"}}
                {{if eq .Type "mhtml"}}
                    <iframe src="/archive/{{$.short_id}}/mhtml/html" class="mhtml-iframe"></iframe>
                    <a href="/archive/{{$.short_id}}/{{.Type}}" class="download-link mhtml-download-link">Download MHTML File</a>
                {{else if eq .Type "screenshot"}}
                    <h3>Full Page Screenshot</h3>
                    <img src="/archive/{{$.short_id}}/{{.Type}}" alt="Full page screenshot" class="screenshot-img">
                {{else if eq .Type "youtube"}}
                    <h3>YouTube Video</h3>
                    <video src="/archive/{{$.short_id}}/{{.Type}}" controls class="video-player">
                        Your browser does not support the video tag.
                    </video>
                    <br><br>
                    <a href="/archive/{{$.short_id}}/{{.Type}}" class="download-link">Download Video</a>
                {{else if eq .Type "git"}}
                    <h3>Git Repository</h3>
                    <div class="git-clone">
                        git clone https://{{$.host}}/git/{{$.short_id}}{{if $.git_clone_name}} {{$.git_clone_name}}{{end}}
                    </div>
                    <a href="/archive/{{$.short_id}}/{{.Type}}" class="download-link">Download Repository Archive</a>
                    <p>You can clone this repository using the git command above{{if $.git_clone_name}} (will create directory "{{$.git_clone_name}}"){{end}}, or download the compressed archive.</p>
                {{end}}
            {{else if eq .Status "pending"}}
                <div class="processing-header">
                    <h3>⏳ Archive Queued</h3>
                    <p>This {{.Type}} archive is waiting to be processed...</p>
                </div>
                <div id="logs-{{.Type}}" class="log-container">Waiting for processing to start...</div>
            {{else if eq .Status "processing"}}
                <div class="processing-header">
                    <h3>⟳ Archive in Progress</h3>
                    <p>Processing {{.Type}} archive for: <strong>{{$.original_url}}</strong></p>
                </div>
                <div id="logs-{{.Type}}" class="log-container">{{if .Logs}}{{.Logs}}{{else}}Starting archive process...{{end}}</div>
            {{else if eq .Status "failed"}}
                <div class="status-failed">
                    <h3>✗ Archive Failed</h3>
                    <p>The {{.Type}} archive failed to complete.</p>
                </div>
                {{if .Logs}}
                <h4>Error Details:</h4>
                <div class="log-container">{{.Logs}}</div>
                {{end}}
            {{end}}
        </div>
        {{end}}
    </div>

    <script>
        let currentTab = null;
        let logPollingInterval = null;
        const shortId = '{{.short_id}}';

        function showTab(type) {
            // Hide all tabs
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tabs a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected tab
            const selectedPane = document.getElementById('tab-' + type);
            const selectedLink = document.querySelector(`a[href="#tab-${type}"]`);
            const tabContent = document.querySelector('.tab-content');
            
            if (selectedPane) {
                selectedPane.classList.add('active');
            }
            if (selectedLink) {
                selectedLink.classList.add('active');
            }
            
            // Add/remove mhtml-active class for proper padding
            if (type === 'mhtml') {
                tabContent.classList.add('mhtml-active');
            } else {
                tabContent.classList.remove('mhtml-active');
            }

            // Start log polling for this tab if it's processing
            currentTab = type;
            startLogPolling();
        }

        async function refreshLogs() {
            if (!currentTab) return;

            try {
                const response = await fetch(`/logs/${shortId}/${currentTab}`);
                const result = await response.json();
                
                if (response.ok) {
                    const logContainer = document.getElementById(`logs-${currentTab}`);
                    if (logContainer) {
                        const newLogs = result.logs || 'No logs available yet...';
                        if (logContainer.textContent !== newLogs) {
                            logContainer.textContent = newLogs;
                            // Scroll to bottom to show latest logs
                            logContainer.scrollTop = logContainer.scrollHeight;
                        }

                        // If status changed to completed, reload the page to show the final result
                        if (result.status === 'completed') {
                            setTimeout(() => location.reload(), 1000);
                        }
                    }
                }
            } catch (error) {
                console.error('Error refreshing logs:', error);
            }
        }

        function startLogPolling() {
            // Clear any existing interval
            if (logPollingInterval) {
                clearInterval(logPollingInterval);
            }
            
            // Only start polling if we have a log container (meaning it's processing/pending)
            const logContainer = document.getElementById(`logs-${currentTab}`);
            if (logContainer) {
                // Start polling every 2 seconds
                logPollingInterval = setInterval(refreshLogs, 2000);
                // Also refresh immediately
                refreshLogs();
            }
        }

        // Show first available tab by default
        document.addEventListener('DOMContentLoaded', function() {
            const firstTab = document.querySelector('.tabs a');
            if (firstTab) {
                const tabType = firstTab.getAttribute('href').replace('#tab-', '');
                showTab(tabType);
            }
        });
    </script>
</body>
</html>
