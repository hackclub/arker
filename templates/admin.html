<!DOCTYPE html>
<html>
<head>
    <title>Arker - Admin Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .url-item { border: 1px solid #ddd; margin-bottom: 20px; padding: 15px; border-radius: 5px; }
        .url-original { font-weight: bold; font-size: 18px; margin-bottom: 10px; word-break: break-all; }
        .captures { margin-left: 20px; }
        .capture-item { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        .capture-link { text-decoration: none; color: #007bff; font-weight: bold; }
        .capture-link:hover { text-decoration: underline; }
        .new-capture-btn { background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .new-capture-btn:hover { background: #218838; }
        .add-url-form { background: #e9ecef; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .add-url-form input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px; width: 400px; }
        .add-url-form button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .status { font-style: italic; color: #666; }
        .archive-items { margin-left: 20px; margin-top: 10px; }
        .archive-item { margin: 5px 0; padding: 8px; background: #ffffff; border: 1px solid #eee; border-radius: 3px; display: flex; justify-content: space-between; align-items: center; }
        .archive-status { font-weight: bold; }
        .status-completed { color: #28a745; }
        .status-pending { color: #ffc107; }
        .status-processing { color: #17a2b8; }
        .status-failed { color: #dc3545; }
        .log-btn { background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; }
        .log-btn:hover { background: #5a6268; }
        .log-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .log-modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-height: 60%; overflow-y: auto; border-radius: 5px; }
        .log-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .log-close:hover { color: black; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Arker - Admin Dashboard</h1>
        <div>
            <a href="/admin/api-keys" style="margin-right: 15px; color: #007bff;">Manage API Keys</a>
            <a href="/docs" style="margin-right: 15px; color: #007bff;">API Docs</a>
            <a href="/login" style="color: #dc3545;">Logout</a>
        </div>
    </div>
    
    <div class="add-url-form">
        <h3>Archive New URL</h3>
        <form id="addUrlForm">
            <input type="url" id="newUrl" placeholder="Enter URL to archive" required>
            <button type="submit">Archive</button>
        </form>
    </div>

    <h2>Archived URLs</h2>
    {{range .urls}}
    <div class="url-item">
        <div class="url-original">{{.Original}}</div>
        <div class="captures">
            {{if .Captures}}
                {{range .Captures}}
                <div class="capture-item">
                    <a href="/{{.ShortID}}" class="capture-link">{{.ShortID}}</a> - 
                    <span>{{.Timestamp.Format "2006-01-02 15:04:05"}}</span>
                    {{if .APIKey}}
                    <span style="color: #6c757d; font-size: 12px; margin-left: 10px;">
                        API: {{.APIKey.Username}}/{{.APIKey.AppName}}/{{.APIKey.Environment}}
                    </span>
                    {{else}}
                    <span style="color: #6c757d; font-size: 12px; margin-left: 10px;">(Admin)</span>
                    {{end}}
                    <div class="archive-items">
                        {{range .ArchiveItems}}
                        <div class="archive-item">
                            <div>
                                <span class="archive-type">{{.Type}}</span>: 
                                <span class="archive-status status-{{.Status}}">{{.Status}}</span>
                                {{if ne .RetryCount 0}}(retry {{.RetryCount}}){{end}}
                            </div>
                            <button class="log-btn" onclick="viewLog({{.ID}})">View Logs</button>
                        </div>
                        {{end}}
                    </div>
                </div>
                {{end}}
            {{else}}
                <div class="status">No captures yet</div>
            {{end}}
        </div>
        <button class="new-capture-btn" onclick="requestCapture({{.ID}})">New Capture</button>
    </div>
    {{end}}

    <!-- Log Modal -->
    <div id="logModal" class="log-modal">
        <div class="log-modal-content">
            <span class="log-close" onclick="closeLogModal()">&times;</span>
            <h2>Archive Logs</h2>
            <pre id="logContent" style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border: 1px solid #ddd; border-radius: 4px; max-height: 400px; overflow-y: auto;"></pre>
        </div>
    </div>

    <script>
        document.getElementById('addUrlForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const url = document.getElementById('newUrl').value;
            
            try {
                const response = await fetch('/admin/archive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });
                
                const result = await response.json();
                if (response.ok) {
                    alert('Archive requested! Short ID: ' + result.short_id);
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        async function requestCapture(urlId) {
            try {
                const response = await fetch(`/admin/url/${urlId}/capture`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (response.ok) {
                    alert('New capture requested! Short ID: ' + result.short_id);
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        let currentLogId = null;
        let logPollingInterval = null;

        async function viewLog(id) {
            try {
                const response = await fetch(`/admin/item/${id}/log`);
                const result = await response.json();
                if (response.ok) {
                    document.getElementById('logContent').textContent = result.logs || 'No logs available';
                    document.getElementById('logModal').style.display = 'block';
                    
                    // Start polling if this is a processing item
                    currentLogId = id;
                    startLogPolling();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error fetching logs: ' + error.message);
            }
        }

        async function refreshLogs() {
            if (!currentLogId) return;
            
            try {
                const response = await fetch(`/admin/item/${currentLogId}/log`);
                const result = await response.json();
                if (response.ok) {
                    const logContent = document.getElementById('logContent');
                    const newLogs = result.logs || 'No logs available';
                    if (logContent.textContent !== newLogs) {
                        logContent.textContent = newLogs;
                        // Scroll to bottom to show latest logs
                        logContent.scrollTop = logContent.scrollHeight;
                    }
                }
            } catch (error) {
                console.error('Error refreshing logs:', error);
            }
        }

        function startLogPolling() {
            // Clear any existing interval
            if (logPollingInterval) {
                clearInterval(logPollingInterval);
            }
            
            // Start polling every 2 seconds
            logPollingInterval = setInterval(refreshLogs, 2000);
        }

        function stopLogPolling() {
            if (logPollingInterval) {
                clearInterval(logPollingInterval);
                logPollingInterval = null;
            }
            currentLogId = null;
        }

        function closeLogModal() {
            document.getElementById('logModal').style.display = 'none';
            stopLogPolling();
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('logModal');
            if (event.target == modal) {
                modal.style.display = 'none';
                stopLogPolling();
            }
        }
    </script>
</body>
</html>
